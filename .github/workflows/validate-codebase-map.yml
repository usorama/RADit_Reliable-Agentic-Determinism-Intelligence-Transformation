name: Validate Codebase Map

on:
  push:
    paths:
      - 'packages/daw-agents/src/**/*.py'
      - 'docs/codebase_map.json'
      - 'scripts/gather_codebase_map.py'
  pull_request:
    paths:
      - 'packages/daw-agents/src/**/*.py'
      - 'docs/codebase_map.json'
      - 'scripts/gather_codebase_map.py'

jobs:
  validate-map:
    name: Validate Codebase Map Matches Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate codebase map
        run: |
          set -e

          # Check map exists
          if [ ! -f docs/codebase_map.json ]; then
            echo "::error::docs/codebase_map.json is missing from repository"
            exit 1
          fi

          # Store committed map hash
          COMMITTED_HASH=$(sha256sum docs/codebase_map.json | cut -d' ' -f1)
          echo "Committed map hash: $COMMITTED_HASH"

          # Regenerate map
          python scripts/gather_codebase_map.py
          echo "Map regenerated successfully"

          # Compare hashes
          FRESH_HASH=$(sha256sum docs/codebase_map.json | cut -d' ' -f1)
          echo "Fresh map hash: $FRESH_HASH"

          if [ "$COMMITTED_HASH" != "$FRESH_HASH" ]; then
            echo ""
            echo "::group::Codebase Map Diff"
            git diff docs/codebase_map.json || true
            echo "::endgroup::"
            echo ""
            echo "::error file=docs/codebase_map.json::Codebase map is out of sync with actual code"
            echo ""
            echo "CODEBASE MAP VALIDATION FAILED"
            echo "==============================="
            echo ""
            echo "The committed docs/codebase_map.json does not match the actual codebase."
            echo ""
            echo "TO FIX:"
            echo "  1. Run: python scripts/gather_codebase_map.py"
            echo "  2. Commit the updated docs/codebase_map.json"
            echo "  3. Push again"
            echo ""
            echo "OR: Install the pre-commit hook to auto-update:"
            echo "    ./scripts/setup-hooks.sh"
            echo ""
            exit 1
          fi

          echo "Codebase map is in sync with actual code"
